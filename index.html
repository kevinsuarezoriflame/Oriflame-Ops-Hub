<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ORIFLAME ¬∑ Operaciones | Reporte de Abastecimiento a PL</title>

  <style>
    :root{
      --mint-50:#EAF9F5;
      --teal-300:#A3E8E7; --teal-500:#49C6B4; --teal-800:#1B6562;

      --panel:#ffffff;
      --ink:#0F172A; --sub:#475569; --line:#D6F1EB;

      --accent: var(--teal-500);
      --accentSoft: rgba(73,198,180,.12);
      --accentLine: rgba(73,198,180,.35);
      --accentDark: var(--teal-800);

      --warn:#B45309;
      --bad:#B91C1C;

      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 16px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background: linear-gradient(180deg, #fff 0%, #fff 60%, var(--mint-50) 100%);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
    }

    .wrap{ max-width: 1200px; margin: 0 auto; padding: 12px; }

    .brand{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    .brand-left{ display:flex; flex-direction:column; gap:6px; }

    .capsule{
      display:inline-flex; align-items:center; gap:8px; width: fit-content;
      padding: 7px 12px; border-radius: 999px;
      border: 1px solid var(--accentLine);
      background: rgba(163,232,231,.35);
      color: var(--accentDark);
      font-weight: 900; letter-spacing: .04em;
      text-transform: uppercase; font-size: 12px;
    }

    .hero{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .hero h1{ margin:0; font-size: 28px; font-weight: 950; letter-spacing: .01em; color: var(--accent); }
    .hero .sub{
      font-size: 12px; color: var(--sub);
      border: 1px solid var(--line); padding: 5px 10px;
      border-radius: 999px; background: var(--mint-50); white-space: nowrap;
    }

    .grid{
      display:grid; grid-template-columns: 1.05fr .95fr;
      gap: 12px; align-items:start; margin-top: 12px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 10px 12px 8px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, #fff 0%, var(--mint-50) 100%);
    }
    .card .hd h2{
      margin:0; font-size: 13px; letter-spacing: .02em;
      font-weight: 950; color: var(--accentDark);
    }
    .card .hd small{ color: var(--sub); font-size: 12px; }
    .card .bd{ padding: 12px; }

    textarea{
      width: 100%; min-height: 125px; resize: vertical;
      padding: 10px; border-radius: 12px;
      border: 1px solid var(--line); outline: none;
      font-family: var(--mono); font-size: 12px; background: #fff;
    }
    textarea:focus{ border-color: var(--accentLine); box-shadow: 0 0 0 4px var(--accentSoft); }

    .btn{
      appearance:none; border: 1px solid var(--line);
      background: #fff; color: var(--ink);
      border-radius: 12px; padding: 9px 11px;
      font-weight: 950; letter-spacing: .01em;
      cursor: pointer; transition: .15s ease;
      user-select:none; font-size: 12px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(15,23,42,.08); border-color:#bfeee5; }
    .btn.primary{ background: var(--accentDark); color: #fff; border-color: var(--accentDark); }
    .btn.accent{ background: var(--accent); color:#fff; border-color: var(--accent); }
    .btn.small{ padding: 7px 9px; border-radius: 10px; font-size: 12px; }
    .btn.danger{ background: #fff; border-color: rgba(185,28,28,.35); color: var(--bad); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }

    .footer-actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 10px;
    }
    .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      border-bottom: 1px solid var(--line);
      padding: 8px 12px; background: var(--mint-50);
    }
    .tab{
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      color: var(--accentDark);
      transition: .12s ease;
    }
    .tab.active{
      background: var(--accentSoft);
      border-color: var(--accentLine);
      box-shadow: 0 0 0 4px var(--accentSoft);
      outline: 2px solid rgba(73,198,180,.25);
    }

    .subtabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px 12px 0;
      align-items:center;
      justify-content:space-between;
    }
    .subtabs-left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .subtab{
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      font-weight: 950;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      color: var(--ink);
      transition: .12s ease;
    }
    .subtab.active{
      background: rgba(27,101,98,.08);
      border-color: rgba(27,101,98,.20);
      box-shadow: 0 0 0 4px rgba(27,101,98,.06);
      color: var(--accentDark);
    }
    .subtab.pending{
      border-color: rgba(185,28,28,.25);
      color: var(--bad);
      background: rgba(185,28,28,.06);
    }
    .subtab.pending.active{
      box-shadow: 0 0 0 4px rgba(185,28,28,.08);
      border-color: rgba(185,28,28,.30);
      background: rgba(185,28,28,.10);
    }

    .kpi{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      padding: 8px 12px 0;
      color: var(--sub);
      font-size: 12px;
    }
    .kpi b{ color: var(--ink); }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 3px 8px; border-radius: 999px;
      font-size: 11px; font-weight: 950;
      border: 1px solid var(--line);
      background: #fff; white-space:nowrap;
    }
    .pill.ok{ border-color: var(--accentLine); color: var(--accentDark); background: var(--accentSoft); }
    .pill.warn{ border-color: rgba(180,83,9,.25); color: var(--warn); background: rgba(180,83,9,.06); }
    .pill.bad{ border-color: rgba(185,28,28,.25); color: var(--bad); background: rgba(185,28,28,.06); }

    .mono{ font-family: var(--mono); }
    .hidden{ display:none !important; }

    .table-wrap{
      max-height: 520px; overflow:auto;
      border: 1px solid var(--line);
      border-radius: 12px; background:#fff;
      margin-top: 8px;
    }

    table{ width:100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
    th, td{ padding: 7px 6px; border-bottom: 1px solid var(--line); vertical-align: top; word-wrap: break-word; }
    th{
      text-align:left; font-size: 11px; color: var(--sub);
      text-transform: uppercase; letter-spacing: .06em;
      background: #fff; position: sticky; top: 0; z-index: 2;
    }

    .compact table{ font-size: 11px; }
    .compact th{ font-size: 10px; }
    .compact th, .compact td{ padding: 6px 6px; }
    .compact .pill{ font-size: 10px; padding: 2px 7px; }

    input[type="number"]{
      width: 100%;
      padding: 7px 9px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      font-family: var(--mono);
      font-size: 12px;
      background:#fff;
    }
    input[type="number"]:focus{
      border-color: var(--accentLine);
      box-shadow: 0 0 0 4px var(--accentSoft);
    }

    .daybar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      padding: 0 12px 10px;
    }

    textarea.out{
      width: 100%;
      min-height: 92px;
      resize: vertical;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      font-family: var(--mono);
      font-size: 12px;
      background:#fff;
      margin-top: 8px;
    }

    .batchbar{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 8px;
    }
    .batchbar .left{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: var(--sub); font-size: 12px;
    }
    select{
      padding: 7px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      font-weight: 900;
      font-size: 12px;
      outline: none;
    }
    select:focus{ border-color: var(--accentLine); box-shadow: 0 0 0 4px var(--accentSoft); }
  </style>
</head>

<body>
  <header>
    <div class="wrap brand">
      <div class="brand-left">
        <div class="capsule">ORIFLAME ¬∑ Operaciones</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px;">
          <div id="syncBadge" style="font-size:12px;color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;padding:6px 10px;border-radius:10px;display:inline-block;">
            Sync: iniciando‚Ä¶
          </div>
          <button class="btn small" id="applyRemote" style="display:none;">‚Üª Recargar nube</button>
          <button class="btn small" id="forceSave" title="Guarda ahora (nube + local)">üíæ Guardar ahora</button>
        </div>

        <div class="hero">
          <h1>Reporte a PL</h1>
          <div class="sub">Nivel 1 vs Nivel 2+ vs Zona Air/CW</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid inputs">
      <div class="card">
        <div class="hd">
          <h2>1) STOCK de PL (Picking)</h2>
          <small>Variante + Caja + Physical Quantity</small>
        </div>
        <div class="bd">
          <textarea id="plInput" placeholder="Pega aqu√≠ tu STOCK PL (TSV)."></textarea>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>2) STOCK RESERVADO (Ventas)</h2>
          <small>C√≥digo + Descripci√≥n + Reserved + Caja (Ubicaci√≥n PL)</small>
        </div>
        <div class="bd">
          <textarea id="resInput" placeholder="Pega aqu√≠ tu STOCK RESERVADO (TSV)."></textarea>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1;">
        <div class="hd">
          <h2>3) STOCK BULK (Bodega)</h2>
          <small>Variante + Ubicaci√≥n + Physical Quantity</small>
        </div>
        <div class="bd">
          <textarea id="bulkInput" placeholder="Pega aqu√≠ tu STOCK BULK (TSV)."></textarea>

          <div class="footer-actions">
            <div class="right">
              <button class="btn danger" id="clearAll">üßπ Limpiar hoja (GLOBAL)</button>
              <button class="btn primary" id="process">Procesar reporte</button>
            </div>
          </div>

          <div style="margin-top:8px;color:#475569;font-size:12px;">
            ‚úÖ Persistencia: al recargar, se restaura desde <b>nube</b> (y fallback local). Solo se borra con <b>Limpiar hoja</b>.
          </div>
        </div>
      </div>
    </div>

    <!-- OUTPUT -->
    <div class="card" id="outCard" style="margin-top:12px;">
      <div class="tabs no-print">
        <div class="tab active" data-panel="p1">Panel 1: Nivel 1 (a pie)</div>
        <div class="tab" data-panel="p2">Panel 2: Nivel 2+ (montacargas)</div>
        <div class="tab" data-panel="p3">Zona Air/CW</div>
      </div>

      <div class="daybar no-print">
        <button class="btn accent" id="downloadDay" disabled>Descargar trabajo del d√≠a</button>
        <button class="btn" id="printDay" disabled>Imprimir trabajo del d√≠a</button>
      </div>

      <!-- PANEL 1 -->
      <section id="panel-p1">
        <div class="kpi">
          <span class="pill ok">Nivel 1</span>
          <span>Total l√≠neas: <b id="p1Lines">0</b></span>
          <span>Unidades requeridas: <b id="p1Need">0</b></span>
          <span>Unidades digitadas: <b id="p1Done">0</b></span>
          <span>Pendientes: <b id="p1Pending">0</b></span>
          <span id="p1Status"></span>
        </div>

        <div class="subtabs no-print">
          <div class="subtabs-left">
            <div class="subtab active" data-sub="p1-report">Reporte</div>
            <div class="subtab pending" data-sub="p1-pending">Pendientes</div>
            <div class="subtab" data-sub="p1-plfmt">Formato PL</div>
          </div>
        </div>

        <div class="bd">
          <div id="p1-report" data-printable class="compact">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:140px;">Descripci√≥n</th>
                    <th style="width:130px;">Ubicaci√≥n Bulk</th>
                    <th style="width:70px;">Qty</th>
                    <th style="width:120px;">Ubicaci√≥n PL</th>
                    <th style="width:150px;">Comentario</th>
                  </tr>
                </thead>
                <tbody id="p1ReportBody"></tbody>
              </table>
            </div>
          </div>

          <div id="p1-pending" class="hidden" data-printable>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:90px;">C√≥digo</th>
                    <th style="width:170px;">Posici√≥n Bulk</th>
                    <th style="width:80px;">Pasar</th>
                    <th style="width:160px;">Qty</th>
                  </tr>
                </thead>
                <tbody id="p1PendingBody"></tbody>
              </table>
            </div>
            <div class="footer-actions no-print">
              <div class="right">
                <button class="btn pending" id="p1CopyPending">Copiar (crea lote)</button>
              </div>
            </div>
            <textarea id="p1CopyPendingText" class="out" readonly></textarea>
          </div>

          <div id="p1-plfmt" class="hidden" data-printable>
            <div class="batchbar no-print">
              <div class="left">
                <span class="pill ok">Lote</span>
                <select id="p1BatchSelect"></select>
              </div>
              <div class="right">
                <button class="btn small" id="p1CopyBatch">Copiar lote</button>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:190px;">Posici√≥n Bulk</th>
                    <th style="width:140px;">Posici√≥n PL</th>
                    <th style="width:90px;">Qty</th>
                    <th style="width:110px;">Verificado</th>
                  </tr>
                </thead>
                <tbody id="p1PLFmtBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL 2 -->
      <section id="panel-p2" class="hidden">
        <div class="kpi">
          <span class="pill warn">Nivel 2+</span>
          <span>Total l√≠neas: <b id="p2Lines">0</b></span>
          <span>Unidades requeridas: <b id="p2Need">0</b></span>
          <span>Unidades digitadas: <b id="p2Done">0</b></span>
          <span>Pendientes: <b id="p2Pending">0</b></span>
          <span id="p2Status"></span>
        </div>

        <div class="subtabs no-print">
          <div class="subtabs-left">
            <div class="subtab active" data-sub="p2-report">Reporte</div>
            <div class="subtab pending" data-sub="p2-pending">Pendientes</div>
            <div class="subtab" data-sub="p2-plfmt">Formato PL</div>
          </div>
        </div>

        <div class="bd">
          <div id="p2-report" data-printable class="compact">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:140px;">Descripci√≥n</th>
                    <th style="width:130px;">Ubicaci√≥n Bulk</th>
                    <th style="width:70px;">Qty</th>
                    <th style="width:120px;">Ubicaci√≥n PL</th>
                    <th style="width:150px;">Comentario</th>
                  </tr>
                </thead>
                <tbody id="p2ReportBody"></tbody>
              </table>
            </div>
          </div>

          <div id="p2-pending" class="hidden" data-printable>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:90px;">C√≥digo</th>
                    <th style="width:170px;">Posici√≥n Bulk</th>
                    <th style="width:80px;">Pasar</th>
                    <th style="width:160px;">Qty</th>
                  </tr>
                </thead>
                <tbody id="p2PendingBody"></tbody>
              </table>
            </div>
            <div class="footer-actions no-print">
              <div class="right">
                <button class="btn pending" id="p2CopyPending">Copiar (crea lote)</button>
              </div>
            </div>
            <textarea id="p2CopyPendingText" class="out" readonly></textarea>
          </div>

          <div id="p2-plfmt" class="hidden" data-printable>
            <div class="batchbar no-print">
              <div class="left">
                <span class="pill ok">Lote</span>
                <select id="p2BatchSelect"></select>
              </div>
              <div class="right">
                <button class="btn small" id="p2CopyBatch">Copiar lote</button>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:190px;">Posici√≥n Bulk</th>
                    <th style="width:140px;">Posici√≥n PL</th>
                    <th style="width:90px;">Qty</th>
                    <th style="width:110px;">Verificado</th>
                  </tr>
                </thead>
                <tbody id="p2PLFmtBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PANEL 3 -->
      <section id="panel-p3" class="hidden">
        <div class="kpi">
          <span class="pill warn">Air/CW</span>
          <span>Total l√≠neas: <b id="p3Lines">0</b></span>
          <span>Unidades requeridas: <b id="p3Need">0</b></span>
          <span>Unidades digitadas: <b id="p3Done">0</b></span>
          <span>Pendientes: <b id="p3Pending">0</b></span>
          <span id="p3Status"></span>
        </div>

        <div class="subtabs no-print">
          <div class="subtabs-left">
            <div class="subtab active" data-sub="p3-report">Reporte</div>
            <div class="subtab pending" data-sub="p3-pending">Pendientes</div>
            <div class="subtab" data-sub="p3-plfmt">Formato PL</div>
          </div>
        </div>

        <div class="bd">
          <div id="p3-report" data-printable class="compact">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:140px;">Descripci√≥n</th>
                    <th style="width:130px;">Ubicaci√≥n Bulk</th>
                    <th style="width:70px;">Qty</th>
                    <th style="width:120px;">Ubicaci√≥n PL</th>
                    <th style="width:150px;">Comentario</th>
                  </tr>
                </thead>
                <tbody id="p3ReportBody"></tbody>
              </table>
            </div>
          </div>

          <div id="p3-pending" class="hidden" data-printable>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:90px;">C√≥digo</th>
                    <th style="width:170px;">Posici√≥n Bulk</th>
                    <th style="width:80px;">Pasar</th>
                    <th style="width:160px;">Qty</th>
                  </tr>
                </thead>
                <tbody id="p3PendingBody"></tbody>
              </table>
            </div>
            <div class="footer-actions no-print">
              <div class="right">
                <button class="btn pending" id="p3CopyPending">Copiar (crea lote)</button>
              </div>
            </div>
            <textarea id="p3CopyPendingText" class="out" readonly></textarea>
          </div>

          <div id="p3-plfmt" class="hidden" data-printable>
            <div class="batchbar no-print">
              <div class="left">
                <span class="pill ok">Lote</span>
                <select id="p3BatchSelect"></select>
              </div>
              <div class="right">
                <button class="btn small" id="p3CopyBatch">Copiar lote</button>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:86px;">C√≥digo</th>
                    <th style="width:190px;">Posici√≥n Bulk</th>
                    <th style="width:140px;">Posici√≥n PL</th>
                    <th style="width:90px;">Qty</th>
                    <th style="width:110px;">Verificado</th>
                  </tr>
                </thead>
                <tbody id="p3PLFmtBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

<script>
/* ========= Core (igual que tu versi√≥n) ========= */
function norm(s){ return (s ?? "").toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""); }
function toInt(v){
  const s=(v??"").toString().trim();
  if(!s) return 0;
  const n=parseInt(s,10);
  return Number.isFinite(n) ? n : 0;
}
function splitLines(text){ return (text||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").map(l=>l.trimEnd()).filter(l=>l.trim().length>0); }
function parseTSV(text){
  const lines=splitLines(text);
  if(lines.length<2) return {headers:[],rows:[]};
  const headers=lines[0].split("\t").map(h=>h.trim());
  const rows=lines.slice(1).map(line=>line.split("\t"));
  return {headers,rows};
}
function findCol(headers,candidates){
  const H=headers.map(norm);
  for(const c of candidates){
    const cn=norm(c);
    const idx=H.findIndex(h=>h===cn||h.includes(cn));
    if(idx!==-1) return idx;
  }
  return -1;
}
function isGoodPLLocation(loc){
  const s=(loc||"").toString().trim();
  if(!s) return false;
  if(norm(s)==="0-0000") return false;
  const last=s.slice(-1).toUpperCase();
  return ["B","C","K","L"].includes(last);
}
function isValidPLBox(loc){
  const s=(loc||"").toString().trim();
  if(!s) return false;
  if(norm(s)==="0-0000") return false;
  return true;
}
function bulkLevel(loc){
  const s=(loc||"").toString().trim();
  const m=s.match(/^(\d{2})-(\d{2})-(\d{3})-(\d{2})$/);
  if(m) return parseInt(m[4],10);
  return null;
}
function bulkAisle(loc){
  const s=(loc||"").toString().trim();
  const m=s.match(/^\d{2}-\d{2}-(\d{3})-\d{2}$/);
  if(!m) return null;
  return parseInt(m[1],10);
}
function specialRank(loc){
  const s=(loc||"").toString().trim();
  const n=norm(s);
  if(n===norm("Inb_PL-CW")) return 9001;
  if(n===norm("Compra Local")) return 9002;
  const cw=s.match(/^Bulk_CW(\d)$/i);
  if(cw) return 9010+parseInt(cw[1],10);
  if(n===norm("Armados_CW")) return 9020;
  if(n===norm("Aereos_CW")) return 9030;
  return 9999;
}
function escapeHTML(s){
  return (s??"").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function compareCodeAsc(a,b){
  const na=parseInt(a,10), nb=parseInt(b,10);
  if(Number.isFinite(na)&&Number.isFinite(nb)) return na-nb;
  return a.localeCompare(b);
}
function firstWord(desc){
  const d=(desc||"").toString().trim();
  if(!d) return "";
  const w=d.split(/\s+/)[0];
  return w.length ? (w[0].toUpperCase()+w.slice(1).toLowerCase()) : "";
}
function idKey(code,bulkLoc){ return `${code}||${bulkLoc}`; }

/* Clipboard */
function copyTextFallback(text){
  const ta=document.createElement("textarea");
  ta.value=text; ta.setAttribute("readonly","");
  ta.style.position="fixed"; ta.style.left="-9999px";
  document.body.appendChild(ta);
  ta.select(); try{document.execCommand("copy");}catch(e){}
  document.body.removeChild(ta);
}
async function copyText(text){
  try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); return true; } }catch(e){}
  copyTextFallback(text); return true;
}

/* Air/CW locations */
const AIRCW_SET = new Set([
  norm("Aereos_CW"),
  norm("Armados_CW"),
  norm("Bulk_CW1"),
  norm("Bulk_CW2"),
  norm("Bulk_CW3"),
  norm("Bulk_CW4"),
  norm("Bulk_CW5"),
  norm("Bulk_CW6"),
  norm("Compra Local"),
  norm("Inb_PL-CW"),
]);
function isAirCW(loc){ return AIRCW_SET.has(norm((loc||"").toString().trim())); }

/* Choose best PL location from a list */
function choosePLLocation(locs){
  const clean = (locs||[]).map(x=>(x||"").toString().trim()).filter(Boolean);
  if(clean.length===0) return "0-0000";
  const good = clean.find(isGoodPLLocation);
  if(good) return good;
  const anyValid = clean.find(isValidPLBox);
  if(anyValid) return anyValid;
  return clean[0] || "0-0000";
}

/* Parse maps */
function buildPLMap(plText){
  const {headers,rows}=parseTSV(plText);
  const iCode=findCol(headers,["Variante"]);
  const iQty=findCol(headers,["Physical Quantity","PhysicalQuantity","Cantidad"]);
  if(iCode<0||iQty<0) throw new Error("PL: No encontr√© columnas (Variante, Physical Quantity).");
  const map=new Map();
  for(const r of rows){
    const code=(r[iCode]||"").trim(); if(!code) continue;
    const qty=toInt(r[iQty]);
    if(!map.has(code)) map.set(code,{stock:0});
    map.get(code).stock+=qty;
  }
  return map;
}
function buildReservedMap(resText){
  const {headers,rows}=parseTSV(resText);
  const iCode=findCol(headers,["Codigo Producto","C√≥digo Producto","Codigo","C√≥digo"]);
  const iDesc=findCol(headers,["Descripcion","Descripci√≥n","Producto","Description"]);
  const iRes=findCol(headers,["Reserved","Reservado"]);
  const iCaja=findCol(headers,["Caja"]);
  if(iCode<0||iRes<0) throw new Error("Reservado: No encontr√© columnas (C√≥digo Producto, Reserved).");
  const map=new Map();
  for(const r of rows){
    const code=(r[iCode]||"").trim(); if(!code) continue;
    const desc=(iDesc>=0?(r[iDesc]||"").trim():"");
    const reserved=toInt(r[iRes]);
    const caja=(iCaja>=0?(r[iCaja]||"").trim():"");
    if(!map.has(code)) map.set(code,{desc,reserved:0, plLocs:[]});
    const it=map.get(code);
    it.reserved+=reserved;
    if(!it.desc && desc) it.desc=desc;
    if(caja) it.plLocs.push(caja);
  }
  for(const it of map.values()){
    it.plLoc = choosePLLocation(it.plLocs);
    it.altaRotacion = isGoodPLLocation(it.plLoc);
  }
  return map;
}
function buildBulkMap(bulkText){
  const {headers,rows}=parseTSV(bulkText);
  const iCode=findCol(headers,["Variante"]);
  const iLoc=findCol(headers,["Ubicacion","Ubicaci√≥n","Location","Caja"]);
  const iQty=findCol(headers,["Physical Quantity","PhysicalQuantity","Cantidad"]);
  if(iCode<0||iLoc<0||iQty<0) throw new Error("Bulk: No encontr√© columnas (Variante, Ubicaci√≥n, Physical Quantity).");
  const map=new Map();
  for(const r of rows){
    const code=(r[iCode]||"").trim(); if(!code) continue;
    const loc=(r[iLoc]||"").trim();
    const qty=toInt(r[iQty]);
    if(!loc||qty<=0) continue;
    if(!map.has(code)) map.set(code,[]);
    map.get(code).push({loc,qty});
  }
  for(const arr of map.values()){
    arr.sort((a,b)=>{
      const aAir=isAirCW(a.loc), bAir=isAirCW(b.loc);
      if(aAir!==bAir) return aAir?1:-1;
      const aa=bulkAisle(a.loc), bb=bulkAisle(b.loc);
      if(aa!==null && bb!==null){
        if(aa!==bb) return aa-bb;
        const al=bulkLevel(a.loc)??999, bl=bulkLevel(b.loc)??999;
        if(al!==bl) return al-bl;
        return a.loc.localeCompare(b.loc);
      }
      if(aa!==null && bb===null) return -1;
      if(aa===null && bb!==null) return 1;
      const ra=specialRank(a.loc), rb=specialRank(b.loc);
      if(ra!==rb) return ra-rb;
      return a.loc.localeCompare(b.loc);
    });
  }
  return map;
}

/* Engine */
function buildMoves(plMap,resMap,bulkMap){
  const moves=[];
  for(const [code,r] of resMap.entries()){
    const reserved=r.reserved;
    if(reserved<=0) continue;
    const pl=plMap.get(code);
    const stockPL=pl?pl.stock:0;
    const plLoc = r.plLoc || "0-0000";
    const alta = !!r.altaRotacion;
    let need=Math.max(0,reserved-stockPL);
    if(need<=0) continue;
    const bulkList=bulkMap.get(code)||[];
    let remaining=need;
    for(const slot of bulkList){
      if(remaining<=0) break;
      const take=Math.min(remaining,slot.qty);
      if(take<=0) continue;
      const flags=[];
      if(!pl) flags.push("NO EN PL");
      if(alta) flags.push("ALTA ROTACION");
      moves.push({code,desc:r.desc||"",bulkLoc:slot.loc,needQty:take,plLoc,flags});
      remaining-=take;
    }
    if(remaining>0){
      const flags=[];
      if(!pl) flags.push("NO EN PL");
      flags.push("BULK INSUFICIENTE");
      if(alta) flags.push("ALTA ROTACION");
      moves.push({code,desc:r.desc||"",bulkLoc:"SIN STOCK (revisar)",needQty:remaining,plLoc,flags});
    }
  }
  return moves;
}
function compareBulkForReport(aLoc,bLoc){
  const aAir=isAirCW(aLoc), bAir=isAirCW(bLoc);
  if(aAir || bAir){
    const ra=specialRank(aLoc), rb=specialRank(bLoc);
    if(ra!==rb) return ra-rb;
    return aLoc.localeCompare(bLoc);
  }
  const aa=bulkAisle(aLoc), bb=bulkAisle(bLoc);
  if(aa!==null && bb!==null){
    if(aa!==bb) return aa-bb;
    return aLoc.localeCompare(bLoc);
  }
  if(aa!==null && bb===null) return -1;
  if(aa===null && bb!==null) return 1;
  return aLoc.localeCompare(bLoc);
}
function splitPanels(moves){
  const p1=[], p2=[], p3=[];
  for(const m of moves){
    if(isAirCW(m.bulkLoc)){ p3.push(m); continue; }
    const lvl=bulkLevel(m.bulkLoc);
    if(lvl===1) p1.push(m);
    else p2.push(m);
  }
  const sorter=(a,b)=>compareBulkForReport(a.bulkLoc,b.bulkLoc)||compareCodeAsc(a.code,b.code);
  p1.sort(sorter); p2.sort(sorter); p3.sort(sorter);
  return {p1,p2,p3};
}
function pillHTML(flags){
  if(!flags||!flags.length) return "";
  return flags.map(f=>{
    const n=norm(f);
    if(n.includes("alta rotacion")) return `<span class="pill ok">ALTA ROTACION</span>`;
    if(n.includes("insuficiente")) return `<span class="pill bad">BULK INSUFICIENTE</span>`;
    if(n.includes("no en pl")) return `<span class="pill warn">NO EN PL</span>`;
    return `<span class="pill">${escapeHTML(f)}</span>`;
  }).join(" ");
}

/* State */
let STATE={
  p1:[], p2:[], p3:[],
  qtyById:new Map(),
  plLocByCode:new Map(),
  moveById:new Map(),
  activePanel:"p1",
  activeSubByPanel:{p1:"p1-report", p2:"p2-report", p3:"p3-report"},
  batchesByPanel:{p1:[], p2:[], p3:[]},
  selectedBatchIdByPanel:{p1:null, p2:null, p3:null}
};

/* Render */
function renderReport(tbody,list){
  tbody.innerHTML="";
  for(const m of list){
    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td class="mono">${escapeHTML(m.code)}</td>
        <td>${escapeHTML(firstWord(m.desc))}</td>
        <td class="mono">${escapeHTML(m.bulkLoc)}</td>
        <td class="mono">${escapeHTML(String(m.needQty))}</td>
        <td class="mono">${escapeHTML(m.plLoc)}</td>
        <td>${pillHTML(m.flags)}</td>
      </tr>
    `);
  }
}
function renderPending(tbody, list){
  tbody.innerHTML = "";
  for(const m of list){
    const id = idKey(m.code, m.bulkLoc);
    const current = STATE.qtyById.get(id) || 0;
    if(current > 0) continue;
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="mono">${escapeHTML(m.code)}</td>
        <td class="mono">${escapeHTML(m.bulkLoc)}</td>
        <td class="mono">PL</td>
        <td>
          <input type="number" min="0" step="1"
                 data-role="qty"
                 data-id="${escapeHTML(id)}"
                 placeholder="${escapeHTML(String(m.needQty))}">
        </td>
      </tr>
    `);
  }
}
function getPendingCount(list){
  let c=0;
  for(const m of list){
    const id=idKey(m.code,m.bulkLoc);
    const q=Number(STATE.qtyById.get(id)||0);
    if(q<=0) c++;
  }
  return c;
}
function sumNeed(list){ return list.reduce((s,x)=>s+toInt(x.needQty),0); }
function sumDone(list){
  return list.reduce((s,x)=>{
    const id=idKey(x.code,x.bulkLoc);
    const q=Number(STATE.qtyById.get(id)||0);
    return s + (Number.isFinite(q)?q:0);
  },0);
}
function setPanelKPI(panelKey,list){
  document.getElementById(panelKey+"Lines").textContent=String(list.length);
  document.getElementById(panelKey+"Need").textContent=String(sumNeed(list));
  document.getElementById(panelKey+"Done").textContent=String(sumDone(list));
  const pending=getPendingCount(list);
  document.getElementById(panelKey+"Pending").textContent=String(pending);
  const statusEl=document.getElementById(panelKey+"Status");
  if(list.length===0) statusEl.innerHTML=`<span class="pill ok">SIN MOVIMIENTOS</span>`;
  else if(pending===0) statusEl.innerHTML=`<span class="pill ok">PANEL LISTO</span>`;
  else statusEl.innerHTML=`<span class="pill bad">FALTAN ${pending}</span>`;
}
function updatePendingTabLabels(){
  document.querySelector('[data-sub="p1-pending"]').textContent=`Pendientes (${getPendingCount(STATE.p1)})`;
  document.querySelector('[data-sub="p2-pending"]').textContent=`Pendientes (${getPendingCount(STATE.p2)})`;
  document.querySelector('[data-sub="p3-pending"]').textContent=`Pendientes (${getPendingCount(STATE.p3)})`;
}
function updateDayButtons(){
  const p1Complete=(STATE.p1.length===0)||(getPendingCount(STATE.p1)===0);
  const p2Complete=(STATE.p2.length===0)||(getPendingCount(STATE.p2)===0);
  const p3Complete=(STATE.p3.length===0)||(getPendingCount(STATE.p3)===0);
  document.getElementById("downloadDay").disabled = !(p1Complete && p2Complete && p3Complete);
  document.getElementById("printDay").disabled = !(p1Complete && p2Complete && p3Complete);
}
function refreshAllTables(){
  renderReport(document.getElementById("p1ReportBody"),STATE.p1);
  renderReport(document.getElementById("p2ReportBody"),STATE.p2);
  renderReport(document.getElementById("p3ReportBody"),STATE.p3);
  renderPending(document.getElementById("p1PendingBody"),STATE.p1);
  renderPending(document.getElementById("p2PendingBody"),STATE.p2);
  renderPending(document.getElementById("p3PendingBody"),STATE.p3);
  setPanelKPI("p1",STATE.p1);
  setPanelKPI("p2",STATE.p2);
  setPanelKPI("p3",STATE.p3);
  updatePendingTabLabels();
  updateDayButtons();
  renderBatchSelect("p1"); renderBatchSelect("p2"); renderBatchSelect("p3");
  renderSelectedBatch("p1"); renderSelectedBatch("p2"); renderSelectedBatch("p3");
}
function nowLabel(){
  const d=new Date();
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  const ss=String(d.getSeconds()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
}
function createBatchFromPendingTbody(panel, tbody){
  const inputs=[...tbody.querySelectorAll('input[data-role="qty"][data-id]')];
  const rows=[];
  for(const inp of inputs){
    const id=inp.getAttribute("data-id");
    const q=Number(STATE.qtyById.get(id)||0);
    if(!(q>0)) continue;
    const m=STATE.moveById.get(id);
    if(!m) continue;
    const plLoc = (STATE.plLocByCode.get(m.code) || m.plLoc || "0-0000");
    rows.push({ code:m.code, bulkLoc:m.bulkLoc, plLoc, qty:q });
  }
  rows.sort((a,b)=>compareCodeAsc(a.code,b.code)||a.bulkLoc.localeCompare(b.bulkLoc));
  if(rows.length===0) return null;
  const batchId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
  const label = `Lote ${STATE.batchesByPanel[panel].length+1} ¬∑ ${nowLabel()}`;
  const batch={ id:batchId, label, createdAt: Date.now(), panel, rows };
  STATE.batchesByPanel[panel].push(batch);
  STATE.selectedBatchIdByPanel[panel]=batchId;
  return batch;
}
function renderBatchSelect(panel){
  const sel = document.getElementById(panel+"BatchSelect");
  if(!sel) return;
  const batches = STATE.batchesByPanel[panel];
  sel.innerHTML="";
  if(batches.length===0){
    const opt=document.createElement("option");
    opt.value=""; opt.textContent="Sin lotes a√∫n";
    sel.appendChild(opt);
    sel.disabled=true;
    return;
  }
  sel.disabled=false;
  for(const b of batches){
    const opt=document.createElement("option");
    opt.value=b.id; opt.textContent=b.label;
    sel.appendChild(opt);
  }
  const want = STATE.selectedBatchIdByPanel[panel] || batches[batches.length-1].id;
  sel.value = want;
}
function renderSelectedBatch(panel){
  const tbodyId = panel==="p1"?"p1PLFmtBody":panel==="p2"?"p2PLFmtBody":"p3PLFmtBody";
  const tbody = document.getElementById(tbodyId);
  if(!tbody) return;
  const batches = STATE.batchesByPanel[panel];
  if(batches.length===0){
    tbody.innerHTML = `<tr><td colspan="5" style="color:#475569;">A√∫n no hay lotes. Usa Pendientes ‚Üí Copiar (crea lote).</td></tr>`;
    return;
  }
  const id = STATE.selectedBatchIdByPanel[panel] || batches[batches.length-1].id;
  const batch = batches.find(b=>b.id===id) || batches[batches.length-1];
  STATE.selectedBatchIdByPanel[panel]=batch.id;
  tbody.innerHTML="";
  for(const r of batch.rows){
    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td class="mono">${escapeHTML(r.code)}</td>
        <td class="mono">${escapeHTML(r.bulkLoc)}</td>
        <td class="mono">${escapeHTML(r.plLoc)}</td>
        <td class="mono">${escapeHTML(String(r.qty))}</td>
        <td style="text-align:center;"><input type="checkbox"></td>
      </tr>
    `);
  }
}
function buildTSVFromBatch(panel){
  const batches = STATE.batchesByPanel[panel];
  if(batches.length===0) return "";
  const id = STATE.selectedBatchIdByPanel[panel] || batches[batches.length-1].id;
  const batch = batches.find(b=>b.id===id) || batches[batches.length-1];
  return batch.rows.map(r=>[r.code,r.bulkLoc,r.plLoc,r.qty].join("\t")).join("\n");
}

/* Tabs */
function setActivePanel(panel){
  STATE.activePanel = panel;
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.panel===panel));
  document.getElementById("panel-p1").classList.toggle("hidden",panel!=="p1");
  document.getElementById("panel-p2").classList.toggle("hidden",panel!=="p2");
  document.getElementById("panel-p3").classList.toggle("hidden",panel!=="p3");
  setActiveSub(panel, STATE.activeSubByPanel[panel] || (panel+"-report"));
}
function setActiveSub(panel,sub){
  STATE.activeSubByPanel[panel] = sub;
  const root=document.getElementById(panel==="p1"?"panel-p1":panel==="p2"?"panel-p2":"panel-p3");
  root.querySelectorAll(".subtab").forEach(s=>s.classList.toggle("active",s.dataset.sub===sub));
  root.querySelectorAll("[id^='"+panel+"-']").forEach(view=>view.classList.toggle("hidden",view.id!==sub));
  if(sub===panel+"-plfmt"){
    renderBatchSelect(panel);
    renderSelectedBatch(panel);
  }
}

/* Process */
function process(){
  const plText=document.getElementById("plInput").value;
  const resText=document.getElementById("resInput").value;
  const bulkText=document.getElementById("bulkInput").value;
  let plMap,resMap,bulkMap,moves;
  try{
    plMap=buildPLMap(plText);
    resMap=buildReservedMap(resText);
    bulkMap=buildBulkMap(bulkText);
    moves=buildMoves(plMap,resMap,bulkMap);
  }catch(e){ alert(e.message); return; }

  const {p1,p2,p3}=splitPanels(moves);
  STATE.p1=p1; STATE.p2=p2; STATE.p3=p3;

  const plLocByCode=new Map();
  for(const [code, it] of resMap.entries()){
    if(it?.plLoc) plLocByCode.set(code, it.plLoc);
  }
  STATE.plLocByCode=plLocByCode;

  STATE.qtyById=new Map();
  STATE.batchesByPanel={p1:[],p2:[],p3:[]};
  STATE.selectedBatchIdByPanel={p1:null,p2:null,p3:null};

  const moveById=new Map();
  for(const m of moves){
    moveById.set(idKey(m.code,m.bulkLoc), m);
  }
  STATE.moveById = moveById;

  refreshAllTables();
  setActivePanel("p1");
  setActiveSub("p1","p1-report");
}

/* Events base */
document.getElementById("process").addEventListener("click",process);
document.getElementById("clearAll").addEventListener("click", async ()=>{ if(typeof window.limpiarHoja==="function"){ await window.limpiarHoja(); } });

document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click",()=>setActivePanel(t.dataset.panel)));
document.querySelectorAll("#panel-p1 .subtab").forEach(s=>s.addEventListener("click",()=>setActiveSub("p1",s.dataset.sub)));
document.querySelectorAll("#panel-p2 .subtab").forEach(s=>s.addEventListener("click",()=>setActiveSub("p2",s.dataset.sub)));
document.querySelectorAll("#panel-p3 .subtab").forEach(s=>s.addEventListener("click",()=>setActiveSub("p3",s.dataset.sub)));

document.addEventListener("input",(ev)=>{
  const el=ev.target;
  if(el && el.matches('input[data-role="qty"]')){
    const id=el.getAttribute("data-id");
    if(!id) return;
    const v=toInt(el.value);
    if(v>0) STATE.qtyById.set(id,v);
    else STATE.qtyById.delete(id);
    setPanelKPI("p1",STATE.p1); setPanelKPI("p2",STATE.p2); setPanelKPI("p3",STATE.p3);
    updatePendingTabLabels(); updateDayButtons();
  }
});

async function handleCopyPending(panel){
  const tbody = document.getElementById(panel+"PendingBody");
  const out = document.getElementById(panel+"CopyPendingText");
  const batch = createBatchFromPendingTbody(panel, tbody);
  const tsv = batch ? batch.rows.map(r=>[r.code,r.bulkLoc,"PL",r.qty].join("\t")).join("\n") : "";
  out.value = tsv;
  await copyText(tsv);
  renderPending(tbody, panel==="p1"?STATE.p1:panel==="p2"?STATE.p2:STATE.p3);
  setPanelKPI("p1",STATE.p1); setPanelKPI("p2",STATE.p2); setPanelKPI("p3",STATE.p3);
  updatePendingTabLabels(); updateDayButtons();
  renderBatchSelect(panel); renderSelectedBatch(panel);
}
document.getElementById("p1CopyPending").addEventListener("click",()=>handleCopyPending("p1"));
document.getElementById("p2CopyPending").addEventListener("click",()=>handleCopyPending("p2"));
document.getElementById("p3CopyPending").addEventListener("click",()=>handleCopyPending("p3"));

document.getElementById("p1BatchSelect").addEventListener("change",(e)=>{ STATE.selectedBatchIdByPanel.p1 = e.target.value || null; renderSelectedBatch("p1"); });
document.getElementById("p2BatchSelect").addEventListener("change",(e)=>{ STATE.selectedBatchIdByPanel.p2 = e.target.value || null; renderSelectedBatch("p2"); });
document.getElementById("p3BatchSelect").addEventListener("change",(e)=>{ STATE.selectedBatchIdByPanel.p3 = e.target.value || null; renderSelectedBatch("p3"); });

document.getElementById("p1CopyBatch").addEventListener("click",async ()=>{ await copyText(buildTSVFromBatch("p1")); });
document.getElementById("p2CopyBatch").addEventListener("click",async ()=>{ await copyText(buildTSVFromBatch("p2")); });
document.getElementById("p3CopyBatch").addEventListener("click",async ()=>{ await copyText(buildTSVFromBatch("p3")); });
</script>

<script type="module">
  // ===== Persistencia TOTAL (Nube + Local) SIN pisarse =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, doc, collection, getDocs, setDoc, deleteDoc,
    onSnapshot, serverTimestamp, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDdXF24bG8QL22a8lkHeHd4ToNq5qDdAI4",
    authDomain: "oriflame-ops-hub.firebaseapp.com",
    projectId: "oriflame-ops-hub",
    storageBucket: "oriflame-ops-hub.firebasestorage.app",
    messagingSenderId: "1052710112933",
    appId: "1:1052710112933:web:ed342948f4fb5eb21f074c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Sala global (1 link, todos)
  const ROOM_ID = "global";
  const base = doc(db, "opsHubRooms", ROOM_ID);

  const hojaRef   = doc(db, "opsHubRooms", ROOM_ID, "state", "hoja");       // estado operativo
  const textsMeta = doc(db, "opsHubRooms", ROOM_ID, "texts", "meta");       // meta + chunks info
  const textsChunksCol = collection(db, "opsHubRooms", ROOM_ID, "textsChunks");

  const CLIENT_ID = (() => {
    try {
      const k = "opsHubClientId";
      const existing = localStorage.getItem(k);
      if (existing) return existing;
      const gen = "c_" + Math.random().toString(16).slice(2) + "_" + Date.now();
      localStorage.setItem(k, gen);
      return gen;
    } catch(e) {
      return "c_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    }
  })();

  // ===== UI badge
  function setSyncBadge(msg, ok=true){
    const el=document.getElementById("syncBadge");
    if(!el) return;
    el.textContent = msg;
    el.style.background = ok ? "#d1e7dd" : "#f8d7da";
    el.style.borderColor = ok ? "#badbcc" : "#f5c2c7";
    el.style.color = ok ? "#0f5132" : "#842029";
  }

  // ===== Local storage (fallback inmediato)
  const LS_KEY = "opsHub_global_snapshot_v1";

  function snapshotToPlainObjectMap(m){
    const obj={}; for(const [k,v] of m.entries()) obj[k]=v; return obj;
  }
  function objectToMap(obj){
    const m=new Map();
    if(!obj||typeof obj!=="object") return m;
    for(const k of Object.keys(obj)){
      const n=parseInt(obj[k],10);
      if(Number.isFinite(n)&&n>0) m.set(k,n);
    }
    return m;
  }

  function readLocal(){
    try{
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function writeLocal(payload){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); }catch(e){}
  }

  function getTexts(){
    return {
      plText: document.getElementById("plInput")?.value || "",
      resText: document.getElementById("resInput")?.value || "",
      bulkText: document.getElementById("bulkInput")?.value || ""
    };
  }
  function setTexts(t){
    if(typeof t.plText==="string") document.getElementById("plInput").value = t.plText;
    if(typeof t.resText==="string") document.getElementById("resInput").value = t.resText;
    if(typeof t.bulkText==="string") document.getElementById("bulkInput").value = t.bulkText;
  }

  function getStatePayload(){
    return {
      version: 10,
      clientId: CLIENT_ID,
      clientUpdatedAt: Date.now(),
      qtyById: snapshotToPlainObjectMap(STATE.qtyById),
      batchesByPanel: STATE.batchesByPanel || {p1:[],p2:[],p3:[]},
      selectedBatchIdByPanel: STATE.selectedBatchIdByPanel || {p1:null,p2:null,p3:null},
      activePanel: STATE.activePanel || "p1",
      activeSubByPanel: STATE.activeSubByPanel || {p1:"p1-report",p2:"p2-report",p3:"p3-report"}
    };
  }

  // ===== Chunking helpers (evita l√≠mite 1MB)
  const MAX_CHUNK = 65000; // ~65KB por chunk, seguro

  function chunkString(str){
    const out=[];
    for(let i=0;i<str.length;i+=MAX_CHUNK) out.push(str.slice(i,i+MAX_CHUNK));
    return out;
  }
  async function saveTextsChunked(texts, updatedAtMs){
    // Borra chunks anteriores, luego sube nuevos
    const batch = writeBatch(db);
    const snap = await getDocs(textsChunksCol);
    snap.forEach(d => batch.delete(d.ref));

    const plChunks = chunkString(texts.plText||"");
    const resChunks = chunkString(texts.resText||"");
    const bulkChunks = chunkString(texts.bulkText||"");

    // Guardar chunks
    plChunks.forEach((c,i)=> batch.set(doc(textsChunksCol, `pl_${i}`), {i, t:"pl", c}));
    resChunks.forEach((c,i)=> batch.set(doc(textsChunksCol, `res_${i}`), {i, t:"res", c}));
    bulkChunks.forEach((c,i)=> batch.set(doc(textsChunksCol, `bulk_${i}`), {i, t:"bulk", c}));

    // Meta
    batch.set(textsMeta, {
      version: 10,
      clientId: CLIENT_ID,
      clientUpdatedAt: updatedAtMs,
      plCount: plChunks.length,
      resCount: resChunks.length,
      bulkCount: bulkChunks.length,
      updatedAt: serverTimestamp()
    }, {merge:true});

    await batch.commit();
  }

  async function loadTextsChunked(){
    const metaSnap = await getDocs(collection(db, "opsHubRooms", ROOM_ID, "texts"));
    // La meta est√° en texts/meta, pero getDocs no trae doc directo; hacemos getDoc simple:
  }

  async function fetchTextsFromChunks(){
    // lee meta
    const meta = await (await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js")).getDoc(textsMeta);
    if(!meta.exists()) return {texts:null, meta:null};
    const m = meta.data()||{};
    // lee chunks
    const snap = await getDocs(textsChunksCol);
    const pl=[],res=[],bulk=[];
    snap.forEach(d=>{
      const x=d.data()||{};
      if(x.t==="pl") pl.push(x);
      else if(x.t==="res") res.push(x);
      else if(x.t==="bulk") bulk.push(x);
    });
    pl.sort((a,b)=>a.i-b.i); res.sort((a,b)=>a.i-b.i); bulk.sort((a,b)=>a.i-b.i);
    const texts = {
      plText: pl.map(x=>x.c||"").join(""),
      resText: res.map(x=>x.c||"").join(""),
      bulkText: bulk.map(x=>x.c||"").join("")
    };
    return {texts, meta:m};
  }

  // ===== No pisar al escribir: si llega remoto, avisar y aplicar solo con bot√≥n
  let isTyping = false;
  let typingTimer = null;
  ["plInput","resInput","bulkInput"].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", ()=>{
      isTyping = true;
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>{ isTyping=false; }, 800);
    });
  });

  const applyBtn = document.getElementById("applyRemote");
  let pendingRemote = null; // {texts, state, metaUpdatedAt, stateUpdatedAt}

  function showApplyButton(show){
    if(!applyBtn) return;
    applyBtn.style.display = show ? "inline-block" : "none";
  }

  
  // Recalcula movimientos SIN borrar avance (qty/lotes). Evita ‚Äúreinicios‚Äù.
  function processPreserve(){
    const plText=document.getElementById("plInput").value;
    const resText=document.getElementById("resInput").value;
    const bulkText=document.getElementById("bulkInput").value;

    let plMap,resMap,bulkMap,moves;
    try{
      plMap=buildPLMap(plText);
      resMap=buildReservedMap(resText);
      bulkMap=buildBulkMap(bulkText);
      moves=buildMoves(plMap,resMap,bulkMap);
    }catch(e){ console.warn(e); return; }

    const {p1,p2,p3}=splitPanels(moves);
    STATE.p1=p1; STATE.p2=p2; STATE.p3=p3;

    // PL location por c√≥digo
    const plLocByCode=new Map();
    for(const [code, it] of resMap.entries()){
      if(it?.plLoc) plLocByCode.set(code, it.plLoc);
    }
    STATE.plLocByCode=plLocByCode;

    // moveById actualizado
    const moveById=new Map();
    const validIds=new Set();
    for(const m of moves){
      const id=idKey(m.code,m.bulkLoc);
      moveById.set(id, m);
      validIds.add(id);
    }
    STATE.moveById=moveById;

    // üîí Mantener avance: filtrar qtyById solo a IDs vigentes
    const filteredQty=new Map();
    for(const [k,v] of (STATE.qtyById||new Map()).entries()){
      if(validIds.has(k) && Number(v)>0) filteredQty.set(k, Number(v));
    }
    STATE.qtyById=filteredQty;

    // üîí Mantener lotes: filtrar filas que ya no existan
    if(STATE.batchesByPanel){
      for(const panel of ["p1","p2","p3"]){
        const arr=(STATE.batchesByPanel[panel]||[]);
        for(const b of arr){
          b.rows = (b.rows||[]).filter(r => validIds.has(idKey(r.code, r.bulkLoc)));
        }
        // opcional: quitar lotes vac√≠os
        STATE.batchesByPanel[panel] = arr.filter(b => (b.rows||[]).length>0);
      }
    }

    refreshAllTables();
  }
function applyRemoteNow(){
    if(!pendingRemote) return;
    const {texts, state} = pendingRemote;

    // aplica texts
    if(texts) setTexts(texts);

    // recalcula si hay data
    const hasAny = (document.getElementById("plInput").value.trim() ||
                    document.getElementById("resInput").value.trim() ||
                    document.getElementById("bulkInput").value.trim());
    if(hasAny){
      try{ processPreserve(); }catch(e){}
    }else{
      STATE.p1=[]; STATE.p2=[]; STATE.p3=[];
      STATE.qtyById=new Map();
      STATE.batchesByPanel={p1:[],p2:[],p3:[]};
      STATE.selectedBatchIdByPanel={p1:null,p2:null,p3:null};
      STATE.moveById=new Map();
      refreshAllTables();
    }

    // aplica state (qty/lotes/tabs) despu√©s del process para que existan tablas
    if(state){
      STATE.qtyById = objectToMap(state.qtyById);
      if(state.batchesByPanel) STATE.batchesByPanel = state.batchesByPanel;
      if(state.selectedBatchIdByPanel) STATE.selectedBatchIdByPanel = state.selectedBatchIdByPanel;
}

    // guardar local
    writeLocal({
      savedAt: Date.now(),
      texts: getTexts(),
      state: getStatePayload()
    });

    pendingRemote = null;
    showApplyButton(false);
    setSyncBadge("Sync: OK (aplicado)", true);
  }

  applyBtn?.addEventListener("click", applyRemoteNow);

  // ===== Guardado (nube + local)
  let saveTimer=null;
  let lastStateWrite=0;
  let lastTextsWrite=0;

  async function saveAllNow(reason="manual"){
    const updatedAt = Date.now();

    // guardar local SIEMPRE
    const localSnap = { savedAt: updatedAt, texts: getTexts(), state: getStatePayload() };
    writeLocal(localSnap);

    setSyncBadge("Sync: guardando‚Ä¶", true);

    try{
      const statePayload = getStatePayload();
      statePayload.clientUpdatedAt = updatedAt;
      lastStateWrite = updatedAt;

      await setDoc(hojaRef, { ...statePayload, updatedAt: serverTimestamp() }, { merge:true });

      // texts chunked
      const texts = getTexts();
      lastTextsWrite = updatedAt;
      await saveTextsChunked(texts, updatedAt);

      setSyncBadge("Sync: OK (guardado)", true);
    }catch(e){
      console.warn(e);
      setSyncBadge("Sync: ERROR (ver consola)", false);
    }
  }

  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>saveAllNow("auto"), 700);
  }

  document.getElementById("forceSave")?.addEventListener("click", ()=>saveAllNow("force"));

  // Guardar cuando se escriben textos
  ["plInput","resInput","bulkInput"].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", scheduleSave);
  });

  // Guardar qty/lotes/pesta√±as
  document.addEventListener("input",(ev)=>{
    const el=ev.target;
    if(el && el.matches('input[data-role="qty"]')) scheduleSave();
  });
  ["p1CopyPending","p2CopyPending","p3CopyPending",
   "p1BatchSelect","p2BatchSelect","p3BatchSelect",
   "p1CopyBatch","p2CopyBatch","p3CopyBatch",
   "process"
  ].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.addEventListener("click", ()=>setTimeout(scheduleSave, 50));
    el.addEventListener("change", ()=>setTimeout(scheduleSave, 50));
  });

  // ===== Restauraci√≥n al cargar: primero LOCAL, luego NUBE
  async function restoreOnLoad(){
    // 1) Local inmediato
    const local = readLocal();
    if(local?.texts){
      setTexts(local.texts);
      const hasAny = (document.getElementById("plInput").value.trim() ||
                      document.getElementById("resInput").value.trim() ||
                      document.getElementById("bulkInput").value.trim());
      if(hasAny){
        try{ processPreserve(); }catch(e){}
      }
      if(local?.state){
        STATE.qtyById = objectToMap(local.state.qtyById);
        if(local.state.batchesByPanel) STATE.batchesByPanel = local.state.batchesByPanel;
        if(local.state.selectedBatchIdByPanel) STATE.selectedBatchIdByPanel = local.state.selectedBatchIdByPanel;
        if(local.state.activeSubByPanel) STATE.activeSubByPanel = local.state.activeSubByPanel;
        refreshAllTables();
      }
      setSyncBadge("Sync: local OK (cargando nube‚Ä¶)", true);
    }else{
      setSyncBadge("Sync: cargando nube‚Ä¶", true);
    }

    // 2) Nube (aplica si es m√°s nueva)
    const {texts, meta} = await fetchTextsFromChunks().catch(()=>({texts:null, meta:null}));
    const stateSnap = await (await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js")).getDoc(hojaRef).catch(()=>null);
    const state = (stateSnap && stateSnap.exists()) ? (stateSnap.data()||{}) : null;

    const cloudTextsTs = meta?.clientUpdatedAt || 0;
    const cloudStateTs = state?.clientUpdatedAt || 0;
    const localTs = local?.savedAt || 0;

    // Si nube es m√°s nueva que local, aplica (pero sin pisar si el usuario est√° tecleando)
    const cloudNewer = Math.max(cloudTextsTs, cloudStateTs) > localTs;

    if(cloudNewer && (texts || state)){
      if(isTyping){
        pendingRemote = {texts, state};
        showApplyButton(true);
        setSyncBadge("Sync: hay nueva data en nube (sin pisar) ¬∑ usa ‚Üª", true);
      }else{
        pendingRemote = {texts, state};
        applyRemoteNow();
      }
    }else{
      setSyncBadge("Sync: OK", true);
    }

    // listeners para cambios de nube (meta + state)
    onSnapshot(textsMeta, async (snap)=>{
      if(!snap.exists()) return;
      const m=snap.data()||{};
      if(m.clientId===CLIENT_ID && m.clientUpdatedAt===lastTextsWrite) return;

      const {texts} = await fetchTextsFromChunks().catch(()=>({texts:null}));
      if(!texts) return;

      if(isTyping){
        pendingRemote = {...(pendingRemote||{}), texts};
        showApplyButton(true);
        setSyncBadge("Sync: nueva data nube (textos) ¬∑ usa ‚Üª", true);
      }else{
        pendingRemote = {...(pendingRemote||{}), texts};
        applyRemoteNow();
      }
    });

    onSnapshot(hojaRef, (snap)=>{
      if(!snap.exists()) return;
      const d=snap.data()||{};
      if(d.clientId===CLIENT_ID && d.clientUpdatedAt===lastStateWrite) return;

      if(isTyping){
        pendingRemote = {...(pendingRemote||{}), state:d};
        showApplyButton(true);
        setSyncBadge("Sync: nueva data nube (estado) ¬∑ usa ‚Üª", true);
      }else{
        pendingRemote = {...(pendingRemote||{}), state:d};
        applyRemoteNow();
      }
    });
  }

  // ===== Limpiar hoja GLOBAL: borra nube + local
  window.limpiarHoja = async function(){
    const ok = confirm("¬øSeguro que deseas LIMPIAR LA HOJA GLOBAL? Esto borra para TODOS.");
    if(!ok) return;
    setSyncBadge("Sync: limpiando‚Ä¶", true);

    try{
      // borrar chunks
      const snap = await getDocs(textsChunksCol);
      const batch = writeBatch(db);
      snap.forEach(d=>batch.delete(d.ref));
      batch.set(textsMeta, {version:10, clientId: CLIENT_ID, clientUpdatedAt: Date.now(), plCount:0,resCount:0,bulkCount:0, updatedAt: serverTimestamp()}, {merge:true});
      batch.set(hojaRef, {
        version:10, clientId: CLIENT_ID, clientUpdatedAt: Date.now(),
        qtyById:{}, batchesByPanel:{p1:[],p2:[],p3:[]},
        selectedBatchIdByPanel:{p1:null,p2:null,p3:null},
        p2:"p2-report",p3:"p3-report"},
        updatedAt: serverTimestamp()
      }, {merge:true});
      await batch.commit();

      // local
      try{ localStorage.removeItem(LS_KEY); }catch(e){}

      // aplicar UI
      document.getElementById("plInput").value="";
      document.getElementById("resInput").value="";
      document.getElementById("bulkInput").value="";
      STATE.p1=[]; STATE.p2=[]; STATE.p3=[];
      STATE.qtyById=new Map();
      STATE.batchesByPanel={p1:[],p2:[],p3:[]};
      STATE.selectedBatchIdByPanel={p1:null,p2:null,p3:null};
      STATE.moveById=new Map();
      refreshAllTables();

      setSyncBadge("Sync: OK (limpio)", true);
    }catch(e){
      console.warn(e);
      setSyncBadge("Sync: ERROR (limpieza)", false);
    }
  };

  // Guardar antes de salir (best-effort)
  window.addEventListener("beforeunload", ()=>{ try{ writeLocal({savedAt:Date.now(), texts:getTexts(), state:getStatePayload()}); }catch(e){} });

  // GO
  restoreOnLoad();
  setSyncBadge("Sync: iniciando‚Ä¶", true);
</script>
</body>
</html>
