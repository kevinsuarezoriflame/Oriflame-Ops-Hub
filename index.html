<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oriflame Ops Hub</title>
  <style>
    :root{
      --bg:#f6fbf9; --panel:#fff; --mint:#bfeee0; --mint-2:#e6fbf4;
      --green:#0f6b57; --green-2:#1c8a70; --text:#12312a; --muted:#5c7a71;
      --border:rgba(18,49,42,.12); --shadow:0 10px 30px rgba(18,49,42,.10);
      --shadow2:0 4px 14px rgba(18,49,42,.10); --focus:rgba(28,138,112,.25);
      --danger:#d64b4b; --radius:16px; --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, var(--mint-2), transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, rgba(191,238,224,.45), transparent 55%),
        var(--bg);
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-columns:330px 1fr;
      gap:14px;
      padding:14px;
      transition:grid-template-columns .18s ease;
    }
    .app.side-collapsed{ grid-template-columns:66px 1fr; }

    .sidebar{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:270px;
      transition: width .18s ease, transform .18s ease, opacity .18s ease;
    }
    .sidebar.collapsed{ width:66px; min-width:66px; }

    .side-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(191,238,224,.55), rgba(255,255,255,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:40px;height:40px;border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--mint), rgba(28,138,112,.25));
      border:1px solid var(--border);
      box-shadow:var(--shadow2);
      font-weight:900;
      color:var(--green);
      flex:0 0 auto;
    }
    .brand-text{line-height:1.1; min-width:0;}
    .brand-text .title{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-text .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sidebar.collapsed .brand-text{display:none;}

    .icon-btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.8);
      color:var(--green);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 2px 10px rgba(18,49,42,.06);
    }
    .icon-btn:active{transform:translateY(1px);}

    .side-tools{padding:12px 14px; display:flex; flex-direction:column; gap:10px;}
    .search{position:relative;}
    .search input{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px 11px 40px;
      background:#fff;
      outline:none;
      font-size:13px;
      transition:box-shadow .18s ease, border-color .18s ease;
    }
    .search input:focus{
      border-color:rgba(28,138,112,.45);
      box-shadow:0 0 0 4px var(--focus);
    }
    .search .lens{
      position:absolute;
      left:12px;
      top:9px;
      color:var(--muted);
      user-select:none;
    }

    .row{display:flex; gap:8px; align-items:center;}
    select, .mini-btn{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
    }
    .mini-btn{
      cursor:pointer;
      color:var(--green);
      box-shadow:0 2px 10px rgba(18,49,42,.05);
    }

    .uploader{
      border:2px dashed rgba(18,49,42,.18);
      border-radius:14px;
      padding:12px;
      background:rgba(191,238,224,.14);
      color:var(--muted);
      font-weight:900;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .uploader.drag{
      background:rgba(191,238,224,.28);
      border-color:rgba(28,138,112,.55);
      color:var(--text);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(18,49,42,.10);
      background:rgba(255,255,255,.7);
      padding:10px;
      border-radius:14px;
    }

    .sidebar.collapsed .side-tools{padding:10px;}
    .sidebar.collapsed .search,
    .sidebar.collapsed .uploader,
    .sidebar.collapsed .row,
    .sidebar.collapsed .hint{display:none;}

    /* Tree */
    .tree{padding:0 10px 10px; overflow:auto; flex:1 1 auto;}
    details{
      border-radius:14px;
      margin:8px 4px;
      overflow:hidden;
      border:1px solid rgba(18,49,42,.06);
      background:rgba(255,255,255,.65);
    }
    details[open]{
      background:#fff;
      border-color:rgba(18,49,42,.10);
      box-shadow:0 6px 18px rgba(18,49,42,.06);
    }
    summary{
      cursor:pointer;
      list-style:none;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
      font-weight:900;
      color:var(--green);
    }
    summary::-webkit-details-marker{display:none;}
    .folder{
      width:26px;height:26px;border-radius:10px;
      background:rgba(191,238,224,.55);
      display:grid;place-items:center;
      border:1px solid rgba(18,49,42,.10);
      color:var(--green);
      flex:0 0 auto;
    }
    .sidebar.collapsed .tree{padding:0 6px 10px;}
    .sidebar.collapsed summary span.lbl{display:none;}
    .sidebar.collapsed .folder{width:34px;height:34px;border-radius:14px;}

    .items{padding:0 8px 10px; display:flex; flex-direction:column; gap:6px;}
    .item{
      width:100%;
      border:1px solid rgba(18,49,42,.10);
      background:linear-gradient(180deg, rgba(191,238,224,.22), rgba(255,255,255,.85));
      border-radius:12px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow:0 2px 10px rgba(18,49,42,.05);
    }
    .item:hover{background:#fff; box-shadow:0 6px 18px rgba(18,49,42,.08);}
    .item-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--green-2); box-shadow:0 0 0 4px rgba(28,138,112,.10);}
    .name{font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .meta{font-family:var(--mono); font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;}
    .item-actions{display:flex; gap:6px; flex:0 0 auto;}
    .pill{
      border:1px solid rgba(18,49,42,.10);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color:var(--green);
      box-shadow:0 2px 10px rgba(18,49,42,.05);
    }
    .pill.danger{color:var(--danger);}

    /* Main */
    .main{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(191,238,224,.35), rgba(255,255,255,0));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .crumb{min-width:0;}
    .crumb .now{font-weight:950; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .crumb .path{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .actions{display:flex; gap:8px; align-items:center;}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--green);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 2px 10px rgba(18,49,42,.05);
    }
    .btn.secondary{color:var(--text);}
    .btn.danger{color:var(--danger);}

    .frame-wrap{
      flex:1 1 auto;
      min-height:0;
      padding:12px;
      background:radial-gradient(900px 500px at 50% 0%, rgba(191,238,224,.18), transparent 55%), var(--bg);
    }
    iframe{
      width:100%;
      height:100%;
      border:1px solid rgba(18,49,42,.10);
      border-radius:14px;
      background:#fff;
      box-shadow:0 10px 30px rgba(18,49,42,.08);
    }
    .status{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-top:1px solid var(--border);
      background:rgba(255,255,255,.65);
    }
    .status b{color:var(--text);}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr;}
      .app.side-collapsed{grid-template-columns:1fr;}
      .sidebar{
        position:fixed; left:14px; right:14px; top:14px; bottom:14px;
        z-index:40;
      }
      .sidebar.hidden-mobile{
        transform:translateY(12px);
        opacity:0;
        pointer-events:none;
      }
      .main{height:calc(100vh - 28px);}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="side-header">
        <div class="brand">
          <div class="logo">OF</div>
          <div class="brand-text">
            <div class="title">Oriflame Ops Hub</div>
            <div class="sub">Centro de herramientas operativas</div>
          </div>
        </div>
        <button class="icon-btn" id="toggleSide" title="Replegar">‚ò∞</button>
      </div>

      <div class="side-tools">
        <div class="search">
          <span class="lens">üîé</span>
          <input id="search" type="text" placeholder="Buscar herramientas" />
        </div>

        <div class="row">
          <select id="categorySelect" style="flex:1">
            <option value="Picking">Picking</option>
            <option value="Dashboards">Dashboards</option>
            <option value="Capacity Tools">Capacity Tools</option>
            <option value="Admin / Utilidades">Admin / Utilidades</option>
          </select>
          <button class="mini-btn" id="btnNewCat" type="button" title="Nueva categor√≠a">Ôºã</button>
        </div>

        <div class="uploader" id="dropZone" title="Arrastra o clic para cargar HTML">
          ‚¨á Arrastra aqu√≠ tus <span style="color:var(--green)">HTML</span><br>
          <span style="font-weight:800;font-size:12px;">o clic para elegir</span>
        </div>
        <input id="filePicker" type="file" accept=".html,text/html" multiple style="display:none" />

        <div class="hint" id="cloudHint">
          <b>Nube:</b> activa. Subes HTML y se sincroniza en Firestore + Storage.
        </div>
      </div>

      <div class="tree" id="tree"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumb">
          <div class="now" id="currentTitle">Selecciona una herramienta</div>
          <div class="path" id="currentPath">Se abrir√° aqu√≠</div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btnHome">üè† Inicio</button>
          <button class="btn" id="btnOpenNew">‚Üó Abrir</button>
          <button class="btn danger" id="btnReloadCloud">üîÑ Recargar</button>
        </div>
      </div>

      <div class="frame-wrap">
        <!-- ‚úÖ iframe con permisos para scripts y clipboard -->
        <iframe
          id="viewer"
          title="Workspace"
          sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-modals allow-downloads allow-top-navigation-by-user-activation"
          allow="clipboard-read; clipboard-write"
          referrerpolicy="no-referrer"
        ></iframe>
      </div>

      <div class="status" id="status">Estado: <b>Listo</b></div>
    </main>
  </div>

  <script type="module">
    // Firebase config (tu bloque)
    const firebaseConfig = {
      apiKey: "AIzaSyDdXF24bG8QL22a8lkHeHd4ToNq5qDdAI4",
      authDomain: "oriflame-ops-hub.firebaseapp.com",
      projectId: "oriflame-ops-hub",
      storageBucket: "oriflame-ops-hub.firebasestorage.app",
      messagingSenderId: "1052710112933",
      appId: "1:1052710112933:web:9917b1fc35e2f28d1f074c"
    };

    // Firebase SDKs (CDN modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);
    const storage = getStorage(fbApp);

    const toolsCol = collection(db, "tools");

    const LS = { collapsed:"of_hub_collapsed", lastDocId:"of_hub_last_docid" };

    const appEl = document.querySelector(".app");
    const sidebar = document.getElementById("sidebar");
    const tree = document.getElementById("tree");
    const viewer = document.getElementById("viewer");
    const currentTitle = document.getElementById("currentTitle");
    const currentPath = document.getElementById("currentPath");
    const searchInput = document.getElementById("search");
    const statusEl = document.getElementById("status");

    const dropZone = document.getElementById("dropZone");
    const filePicker = document.getElementById("filePicker");
    const categorySelect = document.getElementById("categorySelect");
    const btnNewCat = document.getElementById("btnNewCat");

    const isMobile = () => window.matchMedia("(max-width: 980px)").matches;

    function setStatus(msg, ok=true){
      statusEl.innerHTML = `Estado: <b style="color:${ok ? "#12312a" : "#d64b4b"}">${msg}</b>`;
    }

    function setCollapsed(val){
      sidebar.classList.toggle("collapsed", val);
      appEl.classList.toggle("side-collapsed", val);
      localStorage.setItem(LS.collapsed, val ? "1" : "0");
    }
    function loadCollapsed(){
      if(localStorage.getItem(LS.collapsed) === "1") setCollapsed(true);
    }

    function groupIcon(cat){
      const map = { "Picking":"üì¶", "Dashboards":"üìä", "Capacity Tools":"üèóÔ∏è", "Admin / Utilidades":"‚öôÔ∏è" };
      return map[cat] || "üìÅ";
    }

    function showHome(){
      currentTitle.textContent = "Selecciona una herramienta";
      currentPath.textContent = "Se abrir√° aqu√≠";
      viewer.removeAttribute("src");
      viewer.srcdoc = `
        <div style="font-family:system-ui;padding:24px;line-height:1.45">
          <h2 style="margin:0 0 10px;color:#0f6b57">Oriflame Ops Hub</h2>
          <p style="margin:0 0 14px;color:#12312a">
            Sube tus HTML, as√≠gnales categor√≠a y trabaja desde un solo hub.
          </p>
          <div style="padding:14px;border:1px solid rgba(18,49,42,.12);border-radius:14px;background:rgba(191,238,224,.18)">
            Se guarda en Firebase Storage y se lista desde Firestore.
          </div>
        </div>
      `;
    }

    // ‚úÖ Load sin orderBy (evita √≠ndices en Firestore)
    async function loadTools(){
      setStatus("Cargando cat√°logo");
      const snap = await getDocs(toolsCol);
      const list = [];
      snap.forEach(d => list.push({ id: d.id, ...d.data() }));

      // ordenar localmente
      list.sort((a,b)=>{
        const ca = (a.category||"").localeCompare(b.category||"");
        if(ca !== 0) return ca;
        return (a.name||"").localeCompare(b.name||"");
      });

      renderTree(list);
      setStatus(`Listo ‚Ä¢ ${list.length} herramienta(s)`);
      return list;
    }

    function renderTree(list){
      tree.innerHTML = "";
      if(!list.length){
        tree.innerHTML = `<div style="padding:12px;color:var(--muted);font-weight:900;">No hay HTML cargados</div>`;
        return;
      }

      const byCat = list.reduce((acc, t) => {
        (acc[t.category] ||= []).push(t);
        return acc;
      }, {});

      Object.keys(byCat).sort().forEach((cat, idx) => {
        const details = document.createElement("details");
        details.open = idx === 0;

        const summary = document.createElement("summary");
        const folder = document.createElement("div");
        folder.className = "folder";
        folder.textContent = groupIcon(cat);

        const lbl = document.createElement("span");
        lbl.className = "lbl";
        lbl.textContent = cat;

        summary.appendChild(folder);
        summary.appendChild(lbl);
        details.appendChild(summary);

        const items = document.createElement("div");
        items.className = "items";

        byCat[cat].sort((a,b)=> (a.name||"").localeCompare(b.name||"")).forEach(t => {
          const row = document.createElement("div");
          row.className = "item";
          row.dataset.name = (t.name||"").toLowerCase();
          row.dataset.group = (cat||"").toLowerCase();

          const left = document.createElement("div");
          left.className = "item-left";

          const dot = document.createElement("div");
          dot.className = "dot";

          const tw = document.createElement("div");
          tw.style.minWidth = "0";

          const nm = document.createElement("div");
          nm.className = "name";
          nm.textContent = t.name || "Sin nombre";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = "Firebase";

          tw.appendChild(nm);
          tw.appendChild(meta);

          left.appendChild(dot);
          left.appendChild(tw);

          const actions = document.createElement("div");
          actions.className = "item-actions";

          const openBtn = document.createElement("button");
          openBtn.className = "pill";
          openBtn.textContent = "Abrir";
          openBtn.type = "button";
          openBtn.addEventListener("click", () => openCloudTool(t));

          const delBtn = document.createElement("button");
          delBtn.className = "pill danger";
          delBtn.textContent = "Borrar";
          delBtn.type = "button";
          delBtn.addEventListener("click", () => deleteCloudTool(t));

          actions.appendChild(openBtn);
          actions.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(actions);
          items.appendChild(row);
        });

        details.appendChild(items);
        tree.appendChild(details);
      });
    }

    function applyFilter(q){
      const queryTxt = (q || "").trim().toLowerCase();
      const rows = tree.querySelectorAll(".item");
      rows.forEach(r => {
        const hay = (r.dataset.name + " " + r.dataset.group);
        r.style.display = hay.includes(queryTxt) ? "" : "none";
      });
      tree.querySelectorAll("details").forEach(d => {
        const visible = Array.from(d.querySelectorAll(".item")).some(b => b.style.display !== "none");
        d.open = queryTxt ? visible : d.open;
        d.style.display = visible ? "" : (queryTxt ? "none" : "");
      });
      if(!queryTxt){
        tree.querySelectorAll("details").forEach(d => d.style.display = "");
      }
    }

    // ‚úÖ Abrir por srcdoc: trae el HTML desde Storage, inyecta <base href="...">
    async function openCloudTool(tool){
      currentTitle.textContent = tool.name || "Herramienta";
      currentPath.textContent = `${tool.category} ‚Ä¢ Firebase`;

      try{
        setStatus(`Abriendo: ${tool.name}`);

        const res = await fetch(tool.url, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();

        const withBase = html.replace(
          /<head(\s[^>]*)?>/i,
          (m) => `${m}\n<base href="${tool.url}">`
        );

        viewer.removeAttribute("src");
        viewer.srcdoc = withBase;

        localStorage.setItem(LS.lastDocId, tool.id);

        setStatus(`Listo: ${tool.name}`);

        if(isMobile()) sidebar.classList.add("hidden-mobile");
      }catch(err){
        console.error(err);
        setStatus("No se pudo abrir el HTML", false);
        alert("No se pudo abrir el HTML. Revisa consola (F12).");
      }
    }

    async function deleteCloudTool(tool){
      const ok = confirm(`¬øBorrar "${tool.name}"? Se elimina de Storage y del cat√°logo.`);
      if(!ok) return;

      try{
        setStatus(`Borrando: ${tool.name}`);
        if(tool.storagePath){
          await deleteObject(ref(storage, tool.storagePath));
        }
        await deleteDoc(doc(db, "tools", tool.id));
        setStatus(`Borrado: ${tool.name}`);
        await loadTools();
        showHome();
      }catch(err){
        console.error(err);
        setStatus("Error borrando, revisa reglas", false);
        alert("No se pudo borrar. Revisa reglas de Storage/Firestore.");
      }
    }

    function readAsText(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ""));
        fr.onerror = () => reject(fr.error);
        fr.readAsText(file);
      });
    }

    async function uploadHtmlFile(file, category){
      const safeName = file.name.replace(/[^\w.\-]+/g, "_");
      const baseName = file.name.replace(/\.html?$/i, "");
      const ts = Date.now();

      // Preview inmediato
      const htmlText = await readAsText(file);
      currentTitle.textContent = baseName;
      currentPath.textContent = `${category} ‚Ä¢ Subiendo`;
      viewer.removeAttribute("src");
      viewer.srcdoc = htmlText;

      setStatus(`Subiendo: ${file.name}`);

      const storagePath = `tools/${category}/${ts}_${safeName}`;
      const storageRef = ref(storage, storagePath);

      await uploadBytes(storageRef, file, { contentType: "text/html" });
      const url = await getDownloadURL(storageRef);

      await addDoc(toolsCol, {
        name: baseName,
        category,
        storagePath,
        url,
        createdAt: ts
      });

      setStatus(`Subido: ${file.name}`);
    }

    async function handleFiles(files){
      const htmlFiles = Array.from(files || []).filter(f => /\.html?$/i.test(f.name));
      if(!htmlFiles.length){
        setStatus("Solo archivos HTML", false);
        alert("Solo archivos HTML");
        return;
      }
      const category = categorySelect.value;

      try{
        for(const f of htmlFiles){
          await uploadHtmlFile(f, category);
        }
        await loadTools();
      }catch(err){
        console.error(err);
        setStatus("Error subiendo, revisa reglas", false);
        alert("No se pudo subir. Revisa reglas de Firebase (Storage/Firestore).");
      }
    }

    // Events
    document.getElementById("toggleSide").addEventListener("click", () => {
      if(isMobile()){
        sidebar.classList.toggle("hidden-mobile");
        return;
      }
      setCollapsed(!sidebar.classList.contains("collapsed"));
    });

    searchInput.addEventListener("input", (e) => applyFilter(e.target.value));

    btnNewCat.addEventListener("click", () => {
      const cat = prompt("Nombre de la nueva categor√≠a:");
      if(!cat) return;
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
      categorySelect.value = cat;
    });

    dropZone.addEventListener("click", () => filePicker.click());

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("drag");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));

    dropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      dropZone.classList.remove("drag");
      await handleFiles(e.dataTransfer.files);
    });

    filePicker.addEventListener("change", async () => {
      await handleFiles(filePicker.files);
      filePicker.value = "";
    });

    document.getElementById("btnHome").addEventListener("click", showHome);

    document.getElementById("btnOpenNew").addEventListener("click", async () => {
      const lastId = localStorage.getItem(LS.lastDocId);
      if(!lastId){
        alert("Primero abre una herramienta.");
        return;
      }
      const list = await loadTools();
      const tool = list.find(x => x.id === lastId);
      if(!tool?.url){
        alert("No encontr√© el enlace.");
        return;
      }
      window.open(tool.url, "_blank", "noopener,noreferrer");
    });

    document.getElementById("btnReloadCloud").addEventListener("click", async () => {
      await loadTools();
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && isMobile()){
        sidebar.classList.add("hidden-mobile");
      }
    });

    // Init
    loadCollapsed();
    showHome();
    if(isMobile()) sidebar.classList.add("hidden-mobile");

    try{
      await loadTools();
    }catch(err){
      console.error(err);
      setStatus("Error conectando a Firebase, revisa reglas", false);
    }
  </script>
</body>
</html>
